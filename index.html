<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>P29-23_13.geojson 学校種別マップ</title>

  <!-- Leaflet の CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    #map {
      width: 100%;
      height: 100%;
    }
    .leaflet-popup-content {
      margin: 8px 12px;
    }
    .facility-name {
      font-weight: 600;
      margin-bottom: 4px;
      display: block;
    }
    .facility-type {
      font-size: 0.9rem;
      margin-bottom: 2px;
    }
    .facility-address {
      font-size: 0.9rem;
      color: #555;
    }

    /* 種別選択 UI */
    .controls {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1000;
      background: rgba(255, 255, 255, 0.95);
      padding: 8px 10px;
      border-radius: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      max-height: 80vh;
      overflow-y: auto;
      font-size: 13px;
    }
    .controls h2 {
      font-size: 14px;
      margin: 0 0 6px;
    }
    .type-item {
      display: flex;
      align-items: center;
      margin-bottom: 3px;
      gap: 4px;
      cursor: pointer;
      white-space: nowrap;
    }
    .type-color-box {
      width: 12px;
      height: 12px;
      border-radius: 3px;
      border: 1px solid #ccc;
      flex-shrink: 0;
    }
    .type-label-text {
      flex: 1;
    }
  </style>
</head>
<body>
  <!-- 種別コード選択パネル -->
  <div class="controls">
    <h2>表示する種別</h2>
    <div id="type-filters"></div>
  </div>

  <div id="map"></div>

  <!-- Leaflet の JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <script>
    // 学校種別コード → 名称のマッピング（コード表をそのまま使用）
    const schoolTypeMap = {
      "16001": "小学校",
      "16002": "中学校",
      "16003": "中等教育学校",
      "16004": "高等学校",
      "16005": "高等専門学校",
      "16006": "短期大学",
      "16007": "大学",
      "16011": "幼稚園",
      "16012": "特別支援学校",
      "16013": "幼保連携型認定こども園",
      "16014": "義務教育学校",
      "16015": "各種学校",
      "16016": "専修学校"
    };

    // 種別コードごとのマーカー色
    const typeColorMap = {
      "16001": "#e41a1c", // 小学校
      "16002": "#377eb8", // 中学校
      "16003": "#4daf4a", // 中等教育学校
      "16004": "#984ea3", // 高等学校
      "16005": "#ff7f00", // 高等専門学校
      "16006": "#ffff33", // 短期大学
      "16007": "#a65628", // 大学
      "16011": "#f781bf", // 幼稚園
      "16012": "#999999", // 特別支援学校
      "16013": "#1b9e77", // 幼保連携型認定こども園
      "16014": "#d95f02", // 義務教育学校
      "16015": "#7570b3", // 各種学校
      "16016": "#e7298a"  // 専修学校
    };

    // 選択中の種別コード（最初はすべて選択）
    const selectedTypes = new Set(Object.keys(schoolTypeMap));

    // 地図を初期化（日本付近をざっくり表示）
    const map = L.map("map").setView([36.0, 138.0], 5);

    // ベースマップ（OpenStreetMap）
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: "&copy; OpenStreetMap contributors"
    }).addTo(map);

    let geojsonData = null;
    let geojsonLayer = null;
    let hasFittedBounds = false;

    // 種別フィルタ UI を作成
    function buildTypeFilters() {
      const container = document.getElementById("type-filters");
      container.innerHTML = "";

      Object.entries(schoolTypeMap).forEach(([code, label]) => {
        const id = "type_" + code;

        const wrapper = document.createElement("label");
        wrapper.className = "type-item";

        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.id = id;
        checkbox.checked = true;

        const colorBox = document.createElement("span");
        colorBox.className = "type-color-box";
        colorBox.style.backgroundColor = typeColorMap[code] || "#3388ff";

        const text = document.createElement("span");
        text.className = "type-label-text";
        text.textContent = `${label} (${code})`;

        checkbox.addEventListener("change", () => {
          if (checkbox.checked) {
            selectedTypes.add(code);
          } else {
            selectedTypes.delete(code);
          }
          updateLayer();
        });

        wrapper.appendChild(checkbox);
        wrapper.appendChild(colorBox);
        wrapper.appendChild(text);
        container.appendChild(wrapper);
      });
    }

    // GeoJSON レイヤーを更新（フィルタ・色変更を反映）
    function updateLayer() {
      if (!geojsonData) return;

      if (geojsonLayer) {
        map.removeLayer(geojsonLayer);
      }

      geojsonLayer = L.geoJSON(geojsonData, {
        filter: function (feature) {
          const p = feature.properties || {};
          const code = p.P29_003 != null ? String(p.P29_003) : "";
          // 種別コードが選択されているものだけ表示
          return selectedTypes.has(code);
        },
        pointToLayer: function (feature, latlng) {
          const p = feature.properties || {};
          const code = p.P29_003 != null ? String(p.P29_003) : "";
          const color = typeColorMap[code] || "#3388ff";

          return L.circleMarker(latlng, {
            radius: 5,
            weight: 1,
            color: color,
            fillColor: color,
            opacity: 1,
            fillOpacity: 0.8
          });
        },
        onEachFeature: function (feature, layer) {
          const p = feature.properties || {};

          // コード表から種別名に変換
          const code = p.P29_003 != null ? String(p.P29_003) : "";
          const typeName = schoolTypeMap[code] || (code ? "種別コード: " + code : "種別不明");

          const name = p.P29_004 || "名称不明";
          const address = p.P29_005 || "";

          let popupHtml = "";
          popupHtml += `<span class="facility-name">${name}</span>`;
          popupHtml += `<div class="facility-type">種別：${typeName}</div>`;
          if (address) {
            popupHtml += `<div class="facility-address">住所：${address}</div>`;
          }

          layer.bindPopup(popupHtml);
        }
      }).addTo(map);

      // 初回のみ、全ポイントが収まるように地図範囲を調整
      if (!hasFittedBounds) {
        const bounds = geojsonLayer.getBounds();
        if (bounds.isValid()) {
          map.fitBounds(bounds);
        }
        hasFittedBounds = true;
      }
    }

    // GeoJSON ファイルを読み込み（同じフォルダに P29-23_13.geojson がある前提）
    fetch("P29-23_13.geojson")
      .then(response => {
        if (!response.ok) {
          throw new Error("GeoJSON の読み込みに失敗しました: " + response.statusText);
        }
        return response.json();
      })
      .then(data => {
        geojsonData = data;
        buildTypeFilters(); // フィルタ UI を作成
        updateLayer();      // 初回レイヤー描画
      })
      .catch(error => {
        console.error(error);
        alert("GeoJSON の読み込み中にエラーが発生しました。\nコンソールを確認してください。");
      });
  </script>
</body>
</html>
